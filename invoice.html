<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>فاتورة - الكيان</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;500;600;700;800;900&display=swap"
        rel="stylesheet">
    <style>
        body {
            font-family: 'Cairo', sans-serif;
        }

        /* Hide the invoice template from view but keep it renderable */
        #invoice-template-container {
            position: absolute;
            left: -9999px;
            top: 0;
            width: 210mm;
            min-height: 297mm;
            background: white;
        }

        .watermark {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 60%;
            opacity: 0.04;
            pointer-events: none;
            z-index: 0;
        }
    </style>
</head>

<body class="bg-neutral-50 min-h-screen">

    <!-- Header -->
    <header class="fixed top-0 left-0 right-0 z-50 bg-white/95 backdrop-blur-sm border-b border-neutral-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-20">
                <a href="index.html" class="flex items-center ml-auto">
                    <img src="assets/logo.png" alt="الكيان" class="h-40 w-auto">
                </a>
                <nav class="hidden md:flex items-center gap-8">
                    <a href="index.html" class="transition-colors text-neutral-700 hover:text-[#8B7355]">الرئيسية</a>
                    <a href="doors.html" class="transition-colors text-neutral-700 hover:text-[#8B7355]">الأبواب</a>
                    <a href="furniture.html" class="transition-colors text-neutral-700 hover:text-[#8B7355]">الأثاث</a>
                    <a href="kitchens.html" class="transition-colors text-neutral-700 hover:text-[#8B7355]">المطابخ</a>
                    <a href="about.html" class="transition-colors text-neutral-700 hover:text-[#8B7355]">من نحن</a>
                </nav>
            </div>
        </div>
    </header>

    <main class="pt-24 pb-12">
        <div class="max-w-3xl mx-auto px-4">

            <!-- User Input Form (Visible) -->
            <div class="bg-white p-8 rounded-lg shadow-sm border border-neutral-200">
                <div class="text-center mb-8">
                    <h1 class="text-2xl font-bold text-[#8B7355]">إصدار فاتورة جديدة</h1>
                    <p class="text-gray-600 mt-2">أدخل البيانات الأساسية فقط</p>
                </div>

                <!-- Customer Data -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                    <div>
                        <label class="block text-sm font-medium mb-2">اسم الزبون *</label>
                        <input type="text" id="input-customer-name"
                            class="w-full px-4 py-2 border border-neutral-300 rounded-md focus:ring-[#8B7355] focus:border-[#8B7355] outline-none"
                            placeholder="الاسم الكامل">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">رقم الهاتف *</label>
                        <input type="tel" id="input-phone"
                            class="w-full px-4 py-2 border border-neutral-300 rounded-md focus:ring-[#8B7355] focus:border-[#8B7355] outline-none"
                            placeholder="05xxxxxxxx">
                    </div>
                </div>

                <!-- Add Product Section -->
                <div class="bg-neutral-50 p-6 rounded-lg mb-8 border border-neutral-200">
                    <h3 class="font-bold mb-4 flex items-center gap-2">
                        <i data-lucide="plus-circle" class="text-[#8B7355]"></i>
                        إضافة منتج
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium mb-2">نوع المنتج</label>
                            <select id="input-product-type"
                                class="w-full px-4 py-2 border border-neutral-300 rounded-md focus:ring-[#8B7355] focus:border-[#8B7355] outline-none bg-white">
                                <option value="باب داخلي">باب داخلي</option>
                                <option value="باب خارجي">باب خارجي</option>
                                <option value="باب سحاب">باب سحاب</option>
                                <option value="نافذة">نافذة</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">الطول (سم)</label>
                            <input type="number" id="input-length"
                                class="w-full px-4 py-2 border border-neutral-300 rounded-md focus:ring-[#8B7355] focus:border-[#8B7355] outline-none"
                                placeholder="مثال: 210">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">العرض (سم)</label>
                            <input type="number" id="input-width"
                                class="w-full px-4 py-2 border border-neutral-300 rounded-md focus:ring-[#8B7355] focus:border-[#8B7355] outline-none"
                                placeholder="مثال: 90">
                        </div>
                    </div>
                    <button id="add-item-btn"
                        class="w-full bg-white border border-[#8B7355] text-[#8B7355] hover:bg-[#8B7355] hover:text-white py-2 rounded-md transition-colors font-medium">
                        إضافة للقائمة
                    </button>
                </div>

                <!-- Added Items List -->
                <div class="mb-8">
                    <h3 class="font-bold mb-4">المنتجات المضافة (<span id="items-count">0</span>)</h3>
                    <div id="visible-items-list"
                        class="space-y-3 min-h-[100px] border border-dashed border-neutral-300 rounded-lg p-4 bg-neutral-50/50">
                        <p class="text-center text-gray-400 py-4 text-sm">لم يتم إضافة منتجات بعد</p>
                    </div>
                </div>

                <!-- Action Buttons -->
                <button id="generate-pdf-btn"
                    class="w-full bg-[#8B7355] hover:bg-[#6F5C44] text-white py-4 rounded-md font-bold text-lg shadow-md transition-transform hover:scale-[1.01] flex items-center justify-center gap-3">
                    <i data-lucide="download" class="w-6 h-6"></i>
                    تنزيل الفاتورة (PDF)
                </button>
            </div>

        </div>
    </main>

    <!-- Hidden Invoice Template (Ultra-Premium Structured Design) -->
    <div id="invoice-template-container">
        <div id="invoice-content" class="bg-white text-black h-full flex flex-col relative">

            <!-- Watermark -->
            <img src="assets/logo.png" class="watermark" alt="Watermark">

            <!-- Full Width Header -->
            <div class="bg-[#8B7355] text-white px-12 py-8 flex justify-between items-center shadow-md relative z-10">
                <div class="flex items-center gap-6">
                    <div class="bg-white p-2 rounded-lg shadow-sm">
                        <img src="assets/logo.png" alt="الكيان" class="h-24 w-auto object-contain">
                    </div>
                    <div>
                        <h1 class="text-4xl font-black tracking-wide mb-1">الكيان</h1>
                        <p class="text-sm font-medium opacity-90 tracking-wider">لصناعة الأثاث والأبواب والمطابخ</p>
                    </div>
                </div>
                <div class="text-left border-r-2 border-white/30 pr-6">
                    <p class="text-xs font-bold uppercase tracking-[0.2em] opacity-80 mb-1">Invoice No.</p>
                    <p class="text-3xl font-mono font-bold tracking-wider">#4035807</p>
                    <p class="text-sm mt-1 opacity-90 font-mono" id="pdf-header-date"></p>
                </div>
            </div>

            <div class="p-12 flex-grow relative z-10">

                <!-- Customer Info Box -->
                <div
                    class="bg-[#8B7355]/5 border border-[#8B7355]/20 rounded-xl p-6 mb-10 flex justify-between items-center shadow-sm">
                    <div class="flex items-start gap-4">
                        <div class="bg-[#8B7355] text-white p-2 rounded-full mt-1">
                            <i data-lucide="user" class="w-5 h-5"></i>
                        </div>
                        <div>
                            <h3 class="text-xs font-bold text-[#8B7355] uppercase tracking-wider mb-2">بيانات العميل
                                (Customer Info)</h3>
                            <p id="pdf-customer-name" class="text-2xl font-bold text-gray-900 mb-1"></p>
                            <p id="pdf-phone" class="text-gray-600 font-mono text-lg" dir="ltr"></p>
                        </div>
                    </div>
                    <div class="text-left pl-4">
                        <h3 class="text-xs font-bold text-[#8B7355] uppercase tracking-wider mb-2">حالة الفاتورة
                            (Status)</h3>
                        <span
                            class="inline-block bg-green-100 text-green-700 px-4 py-1 rounded-full text-sm font-bold border border-green-200">
                            معتمدة (Approved)
                        </span>
                    </div>
                </div>

                <!-- Structured Table -->
                <div class="mb-10 rounded-xl overflow-hidden border border-gray-200 shadow-sm">
                    <table class="w-full">
                        <thead>
                            <tr class="bg-gray-800 text-white">
                                <th class="py-4 px-6 text-right font-bold w-16 border-l border-gray-700">#</th>
                                <th class="py-4 px-6 text-right font-bold border-l border-gray-700">تفاصيل المنتج
                                    (Description)</th>
                                <th class="py-4 px-6 text-center font-bold w-40 border-l border-gray-700">الأبعاد (Dim)
                                </th>
                                <th class="py-4 px-6 text-center font-bold w-48">السعر (Price)</th>
                            </tr>
                        </thead>
                        <tbody id="pdf-products-container">
                            <!-- Items will be injected here -->
                        </tbody>
                    </table>
                </div>

                <!-- Totals & Terms Grid -->
                <div class="flex gap-8 items-start">

                    <!-- Terms Section (Re-introduced) -->
                    <div class="w-2/3">
                        <h3 class="font-bold text-gray-800 mb-3 flex items-center gap-2">
                            <i data-lucide="file-text" class="w-4 h-4 text-[#8B7355]"></i>
                            الشروط والملاحظات:
                        </h3>
                        <div
                            class="text-[10px] text-gray-500 leading-relaxed grid grid-cols-2 gap-x-4 gap-y-1 bg-gray-50 p-4 rounded-lg border border-gray-100">
                            <p>1. طريقة شغل الأبواب كبس (ام دي اف).</p>
                            <p>2. نوع الطلاء دوكو علي حسب طلب الزبون.</p>
                            <p>3. موعد التسليم 15-20 يوم من استلام العربون.</p>
                            <p>4. تدفع 70% كعربون والباقي قبل التركيب بـ 3 أيام.</p>
                            <p>5. شكل الابواب مرفق مع المقاسات حسب الطلب.</p>
                            <p>6. الشركة غير مسؤولة عن الخدش بعد التسليم.</p>
                            <p>7. الشركة تضمن جودة الخشب ولا تضمن جفافه.</p>
                            <p>8. أي تغيير في العمل يتطلب موعد تركيب جديد.</p>
                        </div>
                    </div>

                    <!-- Totals Section -->
                    <div class="w-1/3 bg-[#8B7355] text-white rounded-xl p-6 shadow-lg">
                        <div class="flex justify-between items-center mb-4 border-b border-white/20 pb-4">
                            <span class="text-sm font-medium opacity-90">المجموع</span>
                            <span class="font-mono font-bold text-lg">---</span>
                        </div>
                        <div class="flex justify-between items-center mb-2">
                            <span class="font-bold text-lg">الإجمالي الكلي</span>
                        </div>
                        <div class="text-right">
                            <span id="pdf-grand-total"
                                class="block text-4xl font-black font-mono tracking-tight">0</span>
                            <span class="text-xs font-medium opacity-80 uppercase tracking-widest">Saudi Riyal</span>
                        </div>
                    </div>
                </div>

                <!-- Signatures -->
                <div class="mt-12 flex justify-between items-end px-8">
                    <div class="text-center">
                        <div class="mb-4 border-b-2 border-gray-300 w-48 mx-auto"></div>
                        <p class="font-bold text-gray-700 text-sm">توقيع العميل (Customer)</p>
                    </div>
                    <div class="text-center">
                        <div class="mb-4 border-b-2 border-[#8B7355] w-48 mx-auto"></div>
                        <p class="font-bold text-[#8B7355] text-sm">ختم الشركة (Company Stamp)</p>
                    </div>
                </div>

            </div>

            <!-- Footer -->
            <div
                class="bg-gray-900 text-white py-4 px-12 flex justify-between items-center text-xs mt-auto relative z-10">
                <div class="flex gap-6 opacity-70">
                    <span class="flex items-center gap-2"><i data-lucide="map-pin" class="w-3 h-3"></i> المملكة العربية
                        السعودية</span>
                    <span class="flex items-center gap-2"><i data-lucide="phone" class="w-3 h-3"></i> 920000000</span>
                </div>
                <div class="opacity-50 font-mono tracking-widest">WWW.ALKAYAN.COM</div>
            </div>
        </div>
    </div>

    <script>
        lucide.createIcons();

        // State
        const items = [];
        const PRICE_PER_METER = 1500;

        // Set Date
        const today = new Date().toLocaleDateString('en-GB');
        document.getElementById('pdf-header-date').textContent = today;

        // Add Item Logic
        document.getElementById('add-item-btn').addEventListener('click', () => {
            const type = document.getElementById('input-product-type').value;
            const length = parseFloat(document.getElementById('input-length').value);
            const width = parseFloat(document.getElementById('input-width').value);

            if (!length || !width) {
                alert('الرجاء إدخال الطول والعرض');
                return;
            }

            // Calculate Price
            const area = (length * width) / 10000;
            const price = Math.round(area * PRICE_PER_METER);

            const newItem = {
                id: Date.now(),
                type,
                length,
                width,
                area: area.toFixed(2),
                price
            };

            items.push(newItem);
            renderVisibleItems();

            // Reset inputs
            document.getElementById('input-length').value = '';
            document.getElementById('input-width').value = '';
        });

        function renderVisibleItems() {
            const container = document.getElementById('visible-items-list');
            const countSpan = document.getElementById('items-count');

            countSpan.textContent = items.length;

            if (items.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-400 py-4 text-sm">لم يتم إضافة منتجات بعد</p>';
                return;
            }

            container.innerHTML = '';
            items.forEach((item, index) => {
                const div = document.createElement('div');
                div.className = 'flex justify-between items-center bg-white p-3 rounded border border-gray-200 shadow-sm';
                div.innerHTML = `
                    <div>
                        <span class="font-bold text-[#8B7355] ml-2">${index + 1}.</span>
                        <span class="font-medium">${item.type}</span>
                        <span class="text-gray-500 text-sm mx-2">|</span>
                        <span class="text-gray-600 text-sm">${item.length} × ${item.width} سم</span>
                    </div>
                    <button onclick="removeItem(${item.id})" class="text-red-500 hover:text-red-700">
                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                    </button>
                `;
                container.appendChild(div);
            });
            lucide.createIcons();
        }

        function removeItem(id) {
            const index = items.findIndex(i => i.id === id);
            if (index > -1) {
                items.splice(index, 1);
                renderVisibleItems();
            }
        }

        // Generate PDF Logic
        document.getElementById('generate-pdf-btn').addEventListener('click', async () => {
            const customerName = document.getElementById('input-customer-name').value;
            const phone = document.getElementById('input-phone').value;

            if (!customerName || !phone) {
                alert('الرجاء إدخال اسم الزبون ورقم الهاتف');
                return;
            }

            if (items.length === 0) {
                alert('الرجاء إضافة منتج واحد على الأقل');
                return;
            }

            // Populate Hidden Template
            document.getElementById('pdf-customer-name').textContent = customerName;
            document.getElementById('pdf-phone').textContent = phone;

            const pdfContainer = document.getElementById('pdf-products-container');
            pdfContainer.innerHTML = '';

            let grandTotal = 0;

            items.forEach((item, index) => {
                grandTotal += item.price;

                // Zebra Striping Logic
                const bgClass = index % 2 === 0 ? 'bg-white' : 'bg-gray-50';

                const itemHtml = `
                    <tr class="${bgClass} border-b border-gray-100">
                        <td class="py-4 px-6 text-right text-gray-500 font-mono text-sm border-l border-gray-100">${index + 1}</td>
                        <td class="py-4 px-6 text-right border-l border-gray-100">
                            <p class="font-bold text-gray-800 text-lg">${item.type}</p>
                            <p class="text-xs text-gray-400 mt-1">شامل التصنيع والتركيب</p>
                        </td>
                        <td class="py-4 px-6 text-center border-l border-gray-100">
                            <span class="bg-white border border-gray-200 text-gray-600 px-2 py-1 rounded text-sm font-mono" dir="ltr">
                                ${item.length} × ${item.width}
                            </span>
                        </td>
                        <td class="py-4 px-6 text-center">
                            <span class="font-bold text-gray-900 font-mono text-lg">${item.price.toLocaleString()}</span>
                        </td>
                    </tr>
                `;
                pdfContainer.innerHTML += itemHtml;
            });

            document.getElementById('pdf-grand-total').textContent = grandTotal.toLocaleString();

            // Generate PDF
            const element = document.getElementById('invoice-content');
            try {
                await document.fonts.ready;

                const canvas = await html2canvas(element, {
                    scale: 2,
                    useCORS: true,
                    logging: false,
                    backgroundColor: '#ffffff'
                });

                const imgData = canvas.toDataURL('image/png');
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF({
                    orientation: 'portrait',
                    unit: 'mm',
                    format: 'a4'
                });

                const imgWidth = 210;
                const imgHeight = (canvas.height * imgWidth) / canvas.width;

                pdf.addImage(imgData, 'PNG', 0, 0, imgWidth, imgHeight);
                pdf.save(`فاتورة_${customerName}.pdf`);
            } catch (error) {
                console.error('PDF Generation Error:', error);
                alert('حدث خطأ أثناء إنشاء الملف');
            }
        });
    </script>
</body>

</html>